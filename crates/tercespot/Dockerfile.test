FROM ubuntu:22.04

# Install dependencies: Rust, Nginx (for logs), and basic utils
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y \
    curl \
    build-essential \
    nginx \
    pkg-config \
    libssl-dev \
    git \
    sudo \
    usbutils \
    libudev-dev \
    socat

# Install Rust
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"

# Create directories
WORKDIR /app
COPY . .

# Build the workspace including all necessary binaries
RUN cargo build --workspace --bin sentinel --bin submitter --bin pulse_device --bin ceremony

# Setup permissions
# Create a non-root user "submitter"
RUN useradd -m -s /bin/bash submitter

# Ensure nginx log file exists and specific permissions are set?
# Sentinel runs as root, so it can read /var/log/nginx/access.log
# But we need to be able to WRITE to it for the test simulation?
# In real life, nginx writes to it. 
# For the test, we might need to `chmod 777` it or have a script running as root do the writing.
# Let's make it world writable for the test duration just to simulate "activity" easily.
RUN touch /var/log/nginx/access.log && chmod 666 /var/log/nginx/access.log

# Create postbox with write permissions for everyone (or specifically submitter)
RUN mkdir -p /tmp/postbox && chmod 777 /tmp/postbox

# Copy validation scripts
COPY scripts/validate_docker.sh /usr/local/bin/validate_docker.sh
COPY scripts/validate_comprehensive.sh /usr/local/bin/validate_comprehensive.sh
RUN chmod +x /usr/local/bin/validate_docker.sh /usr/local/bin/validate_comprehensive.sh

CMD ["/usr/local/bin/validate_comprehensive.sh"]
