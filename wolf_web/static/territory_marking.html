<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wolf Prowler - Territory Marking</title>

    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' https://cdn.tailwindcss.com https://unpkg.com 'unsafe-inline'; style-src 'self' https://cdn.tailwindcss.com 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' http://localhost:8080 https://api.wolfprowler.com; font-src 'self' https: data:;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">

    <!-- Leaflet CSS for World Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>

    <!-- External Resources -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
    <script src="/static/js/territory_live.js" defer></script>
    <script src="/static/js/territory_world.js" defer></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

        :root {
            --primary: #8b5cf6;
            --primary-dark: #7c3aed;
            --secondary: #4f46e5;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #0f172a;
            --light: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #0f172a;
        }

        .glass-morphism {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .territory-map {
            position: relative;
            background: radial-gradient(ellipse at center, rgba(139, 92, 246, 0.05) 0%, rgba(15, 23, 42, 0.9) 70%);
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-radius: 20px;
            overflow: hidden;
        }

        .territory-zone {
            position: absolute;
            border: 2px dashed;
            border-radius: 50%;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .territory-zone:hover {
            transform: scale(1.05);
            filter: brightness(1.2);
        }

        .zone-alpha {
            border-color: #f59e0b;
            background: radial-gradient(circle, rgba(245, 158, 11, 0.1) 0%, transparent 70%);
        }

        .zone-beta {
            border-color: #3b82f6;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
        }

        .zone-omega {
            border-color: #8b5cf6;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.1) 0%, transparent 70%);
        }

        .zone-neutral {
            border-color: #6b7280;
            background: radial-gradient(circle, rgba(107, 114, 128, 0.1) 0%, transparent 70%);
        }

        .territory-marker {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }

            50% {
                transform: translate(-50%, -50%) scale(1.5);
                opacity: 0.7;
            }
        }

        .boundary-line {
            stroke: #8b5cf6;
            stroke-width: 2;
            fill: none;
            stroke-dasharray: 10, 5;
            animation: dashAnimation 20s linear infinite;
        }

        @keyframes dashAnimation {
            0% {
                stroke-dashoffset: 0;
            }

            100% {
                stroke-dashoffset: -30;
            }
        }

        .pack-member-node {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .pack-member-node:hover {
            transform: scale(1.2);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.8);
        }

        .nav-item {
            transition: all 0.2s ease;
        }

        .nav-item:hover {
            background: rgba(139, 92, 246, 0.1);
            color: #8b5cf6;
        }

        .metric-card {
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.15);
        }

        .territory-info {
            position: absolute;
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 12px;
            pointer-events: none;
            z-index: 100;
            display: none;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1e293b;
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .threat-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 4px;
        }

        .threat-low {
            background: #10b981;
        }

        .threat-medium {
            background: #f59e0b;
        }

        .threat-high {
            background: #ef4444;
        }

        .threat-critical {
            background: #dc2626;
            animation: pulse 1s infinite;
        }
    </style>
</head>

<body class="min-h-screen bg-black text-gray-100 font-sans">
    <!-- Sidebar Navigation -->
    <div id="sidebar" class="fixed left-0 top-0 h-full w-64 glass-morphism z-50 border-r border-gray-700 overflow-y-auto">
        <div class="p-6">
            <div class="flex items-center space-x-3 mb-8">
                <div class="w-10 h-10 bg-gradient-to-br from-purple-600 to-blue-600 rounded-lg flex items-center justify-center shadow-lg shadow-purple-500/30">
                    <i data-lucide="shield-alert" class="w-6 h-6 text-white"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">Wolf Prowler</h1>
                    <p class="text-xs text-gray-400">Security Suite v2.0</p>
                </div>
            </div>

            <nav class="space-y-6">
                <!-- Command Center -->
                <div>
                    <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3 px-4">Command Center</h3>
                    <div class="space-y-1">
                        <a href="/static/dashboard_modern.html" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300 hover:text-white hover:bg-white/5 transition-all">
                            <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                            <span>Dashboard</span>
                        </a>
                    </div>
                </div>

                <!-- Security -->
                <div>
                    <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3 px-4">Security</h3>
                    <div class="space-y-1">
                        <a href="/static/security.html" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300 hover:text-white hover:bg-white/5 transition-all">
                            <i data-lucide="shield" class="w-5 h-5"></i>
                            <span>Security Ops</span>
                        </a>
                        <a href="/static/firewall.html" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300 hover:text-white hover:bg-white/5 transition-all">
                            <i data-lucide="shield-alert" class="w-5 h-5"></i>
                            <span>Firewall Control</span>
                        </a>
                        <a href="/static/crypto_advanced_v2.html" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300 hover:text-white hover:bg-white/5 transition-all">
                            <i data-lucide="lock" class="w-5 h-5"></i>
                            <span>Cryptography</span>
                        </a>
                    </div>
                </div>

                <!-- P2P -->
                <div>
                    <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3 px-4">P2P</h3>
                    <div class="space-y-1">
                        <a href="/static/p2p.html" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300 hover:text-white hover:bg-white/5 transition-all">
                            <i data-lucide="share-2" class="w-5 h-5"></i>
                            <span>P2P Mesh</span>
                        </a>
                    </div>
                </div>

                <!-- Network -->
                <div>
                    <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3 px-4">Network</h3>
                    <div class="space-y-1">
                                    <a href="/static/network_map.html" class="nav-item  flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300 hover:text-white hover:bg-white/5 transition-all">
                            <i data-lucide="globe" class="w-5 h-5"></i>
                                        <span>Topology Map</span>
                        </a>
                        <a href="/static/monitoring.html" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300 hover:text-white hover:bg-white/5 transition-all">
                            <i data-lucide="activity" class="w-5 h-5"></i>
                            <span>System Monitoring</span>
                        </a>
                    </div>
                </div>

                <!-- Wolf Sector -->
                <div>
                    <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3 px-4">Wolf Sector</h3>
                    <div class="space-y-1">
                        <a href="/static/territory_marking.html" class="nav-item active flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300 hover:text-white hover:bg-white/5 transition-all">
                            <i data-lucide="map-pin" class="w-5 h-5"></i>
                            <span>Territory Marking</span>
                        </a>
                        <a href="/static/wolf_howl.html" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300 hover:text-white hover:bg-white/5 transition-all">
                            <i data-lucide="radio" class="w-5 h-5"></i>
                            <span>Wolf Howl</span>
                        </a>
                        <a href="/static/wolf_den.html" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300 hover:text-white hover:bg-white/5 transition-all">
                            <i data-lucide="archive" class="w-5 h-5"></i>
                            <span>Wolf Den</span>
                        </a>
                    </div>
                </div>
            </nav>

            <div class="mt-8 pt-6 border-t border-gray-700">
                <a href="/static/settings.html" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-400 hover:text-white hover:bg-white/5 transition-all">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    <span>Settings</span>
                </a>
                <a href="/logout" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-red-400 hover:text-red-300 hover:bg-red-500/10 transition-all">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                    <span>Logout</span>
                </a>
                <div class="mt-4 px-4 text-xs text-center text-gray-500 font-mono">
                    <p>Wolf Prowler v0.1.0</p>
                    <p class="mt-1">Encrypted • Secure</p>
                </div>
            </div>
        </div>
    </div>

    <div class="ml-64">
        <header class="glass-morphism border-b border-gray-700 px-8 py-4 mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold">Territory Marking</h2>
                    <p class="text-gray-400 text-sm mt-1">Visual network boundary indicators</p>
                </div>
                <div class="flex items-center space-x-4">
                     <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-800 transition-colors">
                        <i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i>
                        <i data-lucide="moon" class="w-5 h-5 dark:hidden"></i>
                    </button>
                    <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-blue-600 rounded-full flex items-center justify-center text-white font-bold">
                        WP
                    </div>
                </div>
            </div>
        </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="mb-8 flex justify-between items-end">
            <div>
                <h1 class="text-3xl font-bold mb-2">Territory Marking System</h1>
                <p class="text-gray-400">Visual network boundary indicators and pack territory mapping</p>
            </div>
            <div class="flex space-x-3">
                 <button onclick="toggleTerritoryView()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm transition-colors flex items-center">
                    <i data-lucide="eye" class="w-4 h-4 mr-2"></i>Toggle View
                </button>
                <button onclick="markTerritory()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-sm transition-colors flex items-center">
                    <i data-lucide="plus" class="w-4 h-4 mr-2"></i>Mark Territory
                </button>
            </div>
        </div>

        <!-- Territory Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="glass-morphism rounded-xl p-4 metric-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">Total Territories</p>
                        <p class="text-2xl font-bold text-purple-400" id="total-territories">12</p>
                    </div>
                    <i data-lucide="map" class="w-8 h-8 text-purple-400 opacity-50"></i>
                </div>
            </div>

            <div class="glass-morphism rounded-xl p-4 metric-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">Active Zones</p>
                        <p class="text-2xl font-bold text-green-400" id="active-zones">8</p>
                    </div>
                    <i data-lucide="activity" class="w-8 h-8 text-green-400 opacity-50"></i>
                </div>
            </div>

            <div class="glass-morphism rounded-xl p-4 metric-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">Boundary Alerts</p>
                        <p class="text-2xl font-bold text-yellow-400" id="boundary-alerts">3</p>
                    </div>
                    <i data-lucide="alert-triangle" class="w-8 h-8 text-yellow-400 opacity-50"></i>
                </div>
            </div>

            <div class="glass-morphism rounded-xl p-4 metric-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">Coverage</p>
                        <p class="text-2xl font-bold text-blue-400" id="coverage-percent">87%</p>
                    </div>
                    <i data-lucide="target" class="w-8 h-8 text-blue-400 opacity-50"></i>
                </div>
            </div>
        </div>

        <!-- Territory Map -->
        <div class="glass-morphism rounded-xl p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold flex items-center">
                    <i data-lucide="map-pin" class="w-5 h-5 mr-2 text-purple-400"></i>
                    Territory Map
                </h2>
                <div class="flex items-center space-x-4">
                    <select id="view-mode" onchange="changeViewMode()"
                        class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm">
                        <option value="zones">Territory Zones</option>
                        <option value="boundaries">Boundary Lines</option>
                        <option value="pack">Pack Members</option>
                        <option value="threats">Threat Assessment</option>
                    </select>
                    <button onclick="refreshMap()"
                        class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition-colors">
                        <i data-lucide="refresh-cw" class="w-4 h-4 inline mr-1"></i>Refresh
                    </button>
                </div>
            </div>

            <div id="territory-map" class="territory-map h-96 relative">
                <!-- SVG for boundary lines -->
                <svg id="boundary-svg" class="absolute inset-0 w-full h-full pointer-events-none">
                    <!-- Boundary lines will be drawn here -->
                </svg>

                <!-- Territory zones will be positioned here -->
                <div id="territory-zones">
                    <!-- Territory zones will be generated here -->
                </div>

                <!-- Pack members will be positioned here -->
                <div id="pack-members">
                    <!-- Pack member nodes will be generated here -->
                </div>

                <!-- Territory info tooltip -->
                <div id="territory-info" class="territory-info"></div>
            </div>

            <div class="mt-4 flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-yellow-500 rounded-full mr-2"></div>
                        <span class="text-sm">Alpha Territory</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-blue-500 rounded-full mr-2"></div>
                        <span class="text-sm">Beta Territory</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-purple-500 rounded-full mr-2"></div>
                        <span class="text-sm">Omega Territory</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-gray-500 rounded-full mr-2"></div>
                        <span class="text-sm">Neutral Zone</span>
                    </div>
                </div>
                <div class="text-sm text-gray-400">
                    Last Updated: <span id="last-updated">Just now</span>
                </div>
            </div>
        </div>

        <!-- Territory Details -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Territory List -->
            <div class="glass-morphism rounded-xl p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i data-lucide="list" class="w-5 h-5 mr-2 text-purple-400"></i>
                    Territory Details
                </h2>

                <div id="territory-list" class="space-y-3 max-h-96 overflow-y-auto">
                    <!-- Territory items will be populated here -->
                </div>
            </div>

            <!-- Boundary Alerts -->
            <div class="glass-morphism rounded-xl p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i data-lucide="shield-alert" class="w-5 h-5 mr-2 text-purple-400"></i>
                    Boundary Alerts
                </h2>

                <div id="boundary-alerts-list" class="space-y-3 max-h-96 overflow-y-auto">
                    <!-- Alert items will be populated here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Behavioral Analysis Modal -->
    <div id="behavioral-modal" class="modal">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-semibold">Behavioral Analysis Report</h3>
                <button onclick="closeBehavioralModal()" class="p-1 hover:bg-gray-700 rounded-lg transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="behavioral-report-content">
                <p>Loading report...</p>
            </div>
        </div>
    </div>

    <!-- Territory Modal -->
    <div id="territory-modal" class="modal">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-semibold">Mark New Territory</h3>
                <button onclick="closeTerritoryModal()" class="p-1 hover:bg-gray-700 rounded-lg transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <form id="territory-form" onsubmit="saveTerritory(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Territory Name</label>
                        <input type="text" id="territory-name" required
                            class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2"
                            placeholder="e.g., Northern Hunting Grounds">
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-2">Territory Type</label>
                        <select id="territory-type" required
                            class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2">
                            <option value="alpha">Alpha Territory</option>
                            <option value="beta">Beta Territory</option>
                            <option value="omega">Omega Territory</option>
                            <option value="neutral">Neutral Zone</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-2">Description</label>
                        <textarea id="territory-description" rows="3"
                            class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2"
                            placeholder="Territory purpose and characteristics..."></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Center X (%)</label>
                            <input type="number" id="territory-x" min="0" max="100" required
                                class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2" placeholder="50">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Center Y (%)</label>
                            <input type="number" id="territory-y" min="0" max="100" required
                                class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2" placeholder="50">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-2">Radius (%)</label>
                        <input type="number" id="territory-radius" min="5" max="50" required
                            class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2" placeholder="20">
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-2">Security Level</label>
                        <select id="security-level"
                            class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2">
                            <option value="low">Low - Minimal monitoring</option>
                            <option value="medium">Medium - Regular patrols</option>
                            <option value="high">High - Enhanced surveillance</option>
                            <option value="critical">Critical - Maximum security</option>
                        </select>
                    </div>

                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeTerritoryModal()"
                            class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors">
                            Cancel
                        </button>
                        <button type="submit"
                            class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors">
                            Mark Territory
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Initialize lucide icons
        lucide.createIcons();

        // Global state
        let territories = [];
        let packMembers = [];
        let boundaryAlerts = [];
        let currentViewMode = 'zones';
        let selectedTerritory = null;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', async () => {
            loadTerritories();
            await loadPackMembers();
            loadBoundaryAlerts();
            renderTerritoryMap();
            updateStatistics();
            updateTerritoryList();
            updateBoundaryAlertsList();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Territory map click handler
            document.getElementById('territory-map').addEventListener('click', handleMapClick);

            // Territory zone hover handlers
            document.addEventListener('mouseover', handleTerritoryHover);
            document.addEventListener('mouseout', handleTerritoryLeave);
        }

        function loadTerritories() {
            const savedTerritories = localStorage.getItem('wolf_prowler_territories');
            if (savedTerritories) {
                territories = JSON.parse(savedTerritories);
            } else {
                // Add default territories
                territories = [
                    {
                        id: 1,
                        name: 'Alpha Den',
                        type: 'alpha',
                        x: 25,
                        y: 25,
                        radius: 20,
                        description: 'Primary pack leadership territory',
                        securityLevel: 'critical',
                        active: true
                    },
                    {
                        id: 2,
                        name: 'Beta Zone',
                        type: 'beta',
                        x: 75,
                        y: 25,
                        radius: 15,
                        description: 'Secondary pack member territory',
                        securityLevel: 'high',
                        active: true
                    },
                    {
                        id: 3,
                        name: 'Omega Grounds',
                        type: 'omega',
                        x: 50,
                        y: 75,
                        radius: 18,
                        description: 'General pack member territory',
                        securityLevel: 'medium',
                        active: true
                    },
                    {
                        id: 4,
                        name: 'Neutral Buffer',
                        type: 'neutral',
                        x: 50,
                        y: 50,
                        radius: 10,
                        description: 'Neutral meeting zone',
                        securityLevel: 'low',
                        active: true
                    }
                ];
                saveTerritories();
            }
        }

        async function loadPackMembers() {
            try {
                const response = await fetch('/api/network/peers');
                const data = await response.json();
                packMembers = (data.peers || []).map((peer, index) => ({
                    id: peer.entity_id.peer_id,
                    name: peer.entity_id.peer_id.substring(peer.entity_id.peer_id.length - 6),
                    role: 'beta', // Default role for visualization
                    x: 15 + (index * 20) % 70,
                    y: 25 + Math.floor(index / 4) * 25,
                    status: peer.status
                }));
            } catch (error) {
                console.error("Failed to load pack members from API:", error);
                packMembers = [];
            }
        }

        function loadBoundaryAlerts() {
            boundaryAlerts = [
                {
                    id: 1,
                    type: 'intrusion',
                    severity: 'medium',
                    message: 'Unknown activity detected near Alpha Den boundary',
                    territory: 'Alpha Den',
                    timestamp: new Date().toISOString()
                },
                {
                    id: 2,
                    type: 'breach',
                    severity: 'high',
                    message: 'Potential boundary breach in Beta Zone',
                    territory: 'Beta Zone',
                    timestamp: new Date().toISOString()
                },
                {
                    id: 3,
                    type: 'monitoring',
                    severity: 'low',
                    message: 'Routine boundary patrol completed',
                    territory: 'Omega Grounds',
                    timestamp: new Date().toISOString()
                }
            ];
        }

        function saveTerritories() {
            localStorage.setItem('wolf_prowler_territories', JSON.stringify(territories));
        }

        function renderTerritoryMap() {
            const mapContainer = document.getElementById('territory-map');
            const zonesContainer = document.getElementById('territory-zones');
            const membersContainer = document.getElementById('pack-members');
            const svgContainer = document.getElementById('boundary-svg');

            // Clear existing elements
            zonesContainer.innerHTML = '';
            membersContainer.innerHTML = '';
            svgContainer.innerHTML = '';

            // Render based on view mode
            switch (currentViewMode) {
                case 'zones':
                    renderTerritoryZones(zonesContainer);
                    break;
                case 'boundaries':
                    renderBoundaryLines(svgContainer);
                    break;
                case 'pack':
                    renderPackMembers(membersContainer);
                    break;
                case 'threats':
                    renderThreatAssessment(zonesContainer);
                    break;
                default:
                    renderTerritoryZones(zonesContainer);
                    renderPackMembers(membersContainer);
            }

            // Update last updated time
            document.getElementById('last-updated').textContent = 'Just now';
        }

        function renderTerritoryZones(container) {
            territories.forEach(territory => {
                const zone = document.createElement('div');
                zone.className = `territory-zone zone-${territory.type}`;
                zone.style.left = `${territory.x}%`;
                zone.style.top = `${territory.y}%`;
                zone.style.width = `${territory.radius * 2}%`;
                zone.style.height = `${territory.radius * 2}%`;
                zone.style.transform = 'translate(-50%, -50%)';
                zone.dataset.territoryId = territory.id;

                // Add territory marker
                const marker = document.createElement('div');
                marker.className = 'territory-marker';
                marker.style.background = getTerritoryColor(territory.type);
                marker.style.left = '50%';
                marker.style.top = '50%';
                zone.appendChild(marker);

                container.appendChild(zone);
            });
        }

        function renderBoundaryLines(container) {
            // Create boundary lines between territories
            territories.forEach((territory, index) => {
                if (index < territories.length - 1) {
                    const nextTerritory = territories[index + 1];
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', `${territory.x}%`);
                    line.setAttribute('y1', `${territory.y}%`);
                    line.setAttribute('x2', `${nextTerritory.x}%`);
                    line.setAttribute('y2', `${nextTerritory.y}%`);
                    line.setAttribute('class', 'boundary-line');
                    container.appendChild(line);
                }
            });
        }

        function renderPackMembers(container) {
            packMembers.forEach(member => {
                const node = document.createElement('div');
                node.className = 'pack-member-node';
                node.style.left = `${member.x}%`;
                node.style.top = `${member.y}%`;
                node.style.background = member.status === 'Online' ? getTerritoryColor('beta') : getTerritoryColor('neutral');
                node.style.color = 'white';
                node.style.fontSize = '12px';
                node.style.transform = 'translate(-50%, -50%)';
                node.textContent = member.name;
                node.dataset.memberId = member.id;

                node.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showBehavioralAnalysis(member.id);
                });

                container.appendChild(node);
            });
        }

        function renderThreatAssessment(container) {
            territories.forEach(territory => {
                const zone = document.createElement('div');
                zone.className = `territory-zone zone-${territory.type}`;
                zone.style.left = `${territory.x}%`;
                zone.style.top = `${territory.y}%`;
                zone.style.width = `${territory.radius * 2}%`;
                zone.style.height = `${territory.radius * 2}%`;
                zone.style.transform = 'translate(-50%, -50%)';

                // Add threat indicator
                const threatLevel = getThreatLevel(territory.securityLevel);
                const indicator = document.createElement('div');
                indicator.className = `threat-indicator threat-${threatLevel}`;
                indicator.style.position = 'absolute';
                indicator.style.top = '10px';
                indicator.style.right = '10px';
                zone.appendChild(indicator);

                container.appendChild(zone);
            });
        }

        function getTerritoryColor(type) {
            const colors = {
                alpha: '#f59e0b',
                beta: '#3b82f6',
                omega: '#8b5cf6',
                neutral: '#6b7280'
            };
            return colors[type] || '#6b7280';
        }

        function getThreatLevel(securityLevel) {
            const levels = {
                low: 'low',
                medium: 'medium',
                high: 'high',
                critical: 'critical'
            };
            return levels[securityLevel] || 'low';
        }

        function handleMapClick(event) {
            const rect = event.currentTarget.getBoundingClientRect();
            const x = ((event.clientX - rect.left) / rect.width) * 100;
            const y = ((event.clientY - rect.top) / rect.height) * 100;

            // Set default values in the form
            document.getElementById('territory-x').value = Math.round(x);
            document.getElementById('territory-y').value = Math.round(y);

            // Open territory modal
            markTerritory();
        }

        function handleTerritoryHover(event) {
            const territoryElement = event.target.closest('.territory-zone');
            if (territoryElement) {
                const territoryId = territoryElement.dataset.territoryId;
                const territory = territories.find(t => t.id == territoryId);
                if (territory) {
                    showTerritoryInfo(territory, event.pageX, event.pageY);
                }
            }
        }

        function handleTerritoryLeave() {
            document.getElementById('territory-info').style.display = 'none';
        }

        function showTerritoryInfo(territory, x, y) {
            const info = document.getElementById('territory-info');
            info.innerHTML = `
                <div class="font-semibold">${territory.name}</div>
                <div class="text-xs text-gray-400">${territory.description}</div>
                <div class="text-xs">Security: ${territory.securityLevel}</div>
            `;
            info.style.left = `${x + 10}px`;
            info.style.top = `${y + 10}px`;
            info.style.display = 'block';
        }

        function updateStatistics() {
            document.getElementById('total-territories').textContent = territories.length;
            document.getElementById('active-zones').textContent = territories.filter(t => t.active).length;
            document.getElementById('boundary-alerts').textContent = boundaryAlerts.length;

            // Calculate coverage (simplified)
            const totalArea = 100 * 100; // 100% x 100%
            const coveredArea = territories.reduce((sum, t) => sum + (Math.PI * t.radius * t.radius), 0);
            const coverage = Math.min(100, Math.round((coveredArea / totalArea) * 100));
            document.getElementById('coverage-percent').textContent = `${coverage}%`;
        }

        function updateTerritoryList() {
            const container = document.getElementById('territory-list');
            container.innerHTML = territories.map(territory => `
                <div class="flex items-center justify-between p-3 bg-gray-800/50 rounded-lg">
                    <div class="flex items-center space-x-3">
                        <div class="w-4 h-4 rounded-full" style="background: ${getTerritoryColor(territory.type)}"></div>
                        <div>
                            <div class="font-medium">${territory.name}</div>
                            <div class="text-sm text-gray-400">${territory.type} • ${territory.securityLevel} security</div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="threat-indicator threat-${getThreatLevel(territory.securityLevel)}"></span>
                        <button onclick="deleteTerritory(${territory.id})" class="p-1 hover:bg-red-600 rounded transition-colors">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            // Re-initialize icons
            lucide.createIcons();
        }

        function updateBoundaryAlertsList() {
            const container = document.getElementById('boundary-alerts-list');
            container.innerHTML = boundaryAlerts.map(alert => `
                <div class="flex items-center justify-between p-3 bg-gray-800/50 rounded-lg">
                    <div class="flex items-center space-x-3">
                        <span class="threat-indicator threat-${alert.severity}"></span>
                        <div>
                            <div class="font-medium">${alert.message}</div>
                            <div class="text-sm text-gray-400">${alert.territory} • ${new Date(alert.timestamp).toLocaleTimeString()}</div>
                        </div>
                    </div>
                    <button onclick="dismissAlert(${alert.id})" class="p-1 hover:bg-gray-600 rounded transition-colors">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            `).join('');

            // Re-initialize icons
            lucide.createIcons();
        }

        function changeViewMode() {
            currentViewMode = document.getElementById('view-mode').value;
            renderTerritoryMap();
        }

        function toggleTerritoryView() {
            const modes = ['zones', 'boundaries', 'pack', 'threats'];
            const currentIndex = modes.indexOf(currentViewMode);
            currentViewMode = modes[(currentIndex + 1) % modes.length];
            document.getElementById('view-mode').value = currentViewMode;
            renderTerritoryMap();
        }

        function refreshMap() {
            renderTerritoryMap();
            updateStatistics();
            updateTerritoryList();
            updateBoundaryAlertsList();
        }

        function markTerritory() {
            document.getElementById('territory-modal').classList.add('active');
        }

        function closeTerritoryModal() {
            document.getElementById('territory-modal').classList.remove('active');
            document.getElementById('territory-form').reset();
        }

        function saveTerritory(event) {
            event.preventDefault();

            const territory = {
                id: Date.now(),
                name: document.getElementById('territory-name').value,
                type: document.getElementById('territory-type').value,
                description: document.getElementById('territory-description').value,
                x: parseFloat(document.getElementById('territory-x').value),
                y: parseFloat(document.getElementById('territory-y').value),
                radius: parseFloat(document.getElementById('territory-radius').value),
                securityLevel: document.getElementById('security-level').value,
                active: true
            };

            territories.push(territory);
            saveTerritories();
            renderTerritoryMap();
            updateStatistics();
            updateTerritoryList();
            closeTerritoryModal();
        }

        function deleteTerritory(id) {
            if (confirm('Delete this territory?')) {
                territories = territories.filter(t => t.id !== id);
                saveTerritories();
                renderTerritoryMap();
                updateStatistics();
                updateTerritoryList();
            }
        }

        function dismissAlert(id) {
            boundaryAlerts = boundaryAlerts.filter(a => a.id !== id);
            updateBoundaryAlertsList();
            updateStatistics();
        }
    </script>
</body>
    </div>

</html>