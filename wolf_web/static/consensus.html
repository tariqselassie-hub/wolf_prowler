<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wolf Prowler - Distributed Consensus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/static/js/wolf_live.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: #000000;
            color: #e5e7eb;
        }

        .mono-font {
            font-family: 'JetBrains Mono', monospace;
        }

        .glass-morphism {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .metric-card {
            background: rgba(17, 24, 39, 0.7);
            border: 1px solid rgba(75, 85, 99, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .metric-card:hover {
            border-color: rgba(139, 92, 246, 0.5);
            box-shadow: 0 10px 30px -10px rgba(139, 92, 246, 0.3);
            transform: translateY(-2px);
        }

        .node-active { border-color: #22c55e; box-shadow: 0 0 15px rgba(34, 197, 94, 0.3); }
        .node-leader { border-color: #f59e0b; box-shadow: 0 0 15px rgba(245, 158, 11, 0.3); }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    </style>
</head>

<body class="min-h-screen">
    <!-- Sidebar -->
    <div id="sidebar" class="fixed left-0 top-0 h-full w-64 glass-morphism z-50 border-r border-gray-700 overflow-y-auto">
        <div class="p-6">
                        <div class="flex items-center space-x-3 mb-8">
                            <div class="w-10 h-10 bg-gradient-to-br from-purple-600 to-blue-600 rounded-lg flex items-center justify-center shadow-lg shadow-purple-500/30">
                                <i data-lucide="shield-alert" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <h1 class="text-xl font-bold bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">Wolf Prowler</h1>
                                <p class="text-xs text-gray-400">Security Suite v2.0</p>
                            </div>
                        </div>
            
                        <nav class="space-y-6">
                            <!-- Command Center -->
                            <div>
                                <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3 px-4">Command Center</h3>
                                <div class="space-y-1">
                                    <a href="/static/dashboard_modern.html" class="nav-item  flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300 hover:text-white hover:bg-white/5 transition-all">
                                        <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                                        <span>Dashboard</span>
                                    </a>
                                </div>
                            </div>
            
                            <!-- Security -->
                            <div>
                                <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3 px-4">Security</h3>
                                <div class="space-y-1">
                                    <a href="/static/security.html" class="nav-item  flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300 hover:text-white hover:bg-white/5 transition-all">
                                        <i data-lucide="shield" class="w-5 h-5"></i>
                                        <span>Security Ops</span>
                                    </a>
                                    <a href="/static/siem_dashboard.html" class="nav-item  flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300 hover:text-white hover:bg-white/5 transition-all">
                                        <i data-lucide="file-text" class="w-5 h-5"></i>
                                        <span>SIEM / Logs</span>
                                    </a>
                                    <a href="/static/soar_dashboard.html" class="nav-item  flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300 hover:text-white hover:bg-white/5 transition-all">
                                        <i data-lucide="zap" class="w-5 h-5"></i>
                                        <span>SOAR</span>
                                    </a>
                                    <a href="/static/firewall.html" class="nav-item  flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300 hover:text-white hover:bg-white/5 transition-all">
                                        <i data-lucide="shield-alert" class="w-5 h-5"></i>
                                        <span>Firewall</span>
                                    </a>
                                </div>
                            </div>
            
                            <!-- Network -->
                            <div>
                                <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3 px-4">Network</h3>
                                <div class="space-y-1">
                                    <a href="/static/network_map.html" class="nav-item  flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300 hover:text-white hover:bg-white/5 transition-all">
                                        <i data-lucide="globe" class="w-5 h-5"></i>
                                        <span>Topology Map</span>
                                    </a>
                                    <a href="/static/p2p.html" class="nav-item  flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300 hover:text-white hover:bg-white/5 transition-all">
                                        <i data-lucide="share-2" class="w-5 h-5"></i>
                                        <span>P2P Mesh</span>
                                    </a>
                                    <a href="/static/howl.html" class="nav-item  flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300 hover:text-white hover:bg-white/5 transition-all">
                                        <i data-lucide="radio" class="w-5 h-5"></i>
                                        <span>Wolf Howl</span>
                                    </a>
                                     <a href="/static/packs.html" class="nav-item  flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300 hover:text-white hover:bg-white/5 transition-all">
                                        <i data-lucide="users" class="w-5 h-5"></i>
                                        <span>Wolf Packs</span>
                                    </a>
                                </div>
                            </div>
            
                            <!-- Operations -->
                            <div>
                                <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3 px-4">Operations</h3>
                                <div class="space-y-1">
                                     <a href="/static/monitoring.html" class="nav-item  flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300 hover:text-white hover:bg-white/5 transition-all">
                                        <i data-lucide="activity" class="w-5 h-5"></i>
                                        <span>Monitoring</span>
                                    </a>
                                    <a href="/consensus" class="nav-item active flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300 hover:text-white hover:bg-white/5 transition-all">
                                        <i data-lucide="git-branch" class="w-5 h-5"></i>
                                        <span>Consensus</span>
                                    </a>
                                    <a href="/static/crypto_advanced_v2.html" class="nav-item  flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300 hover:text-white hover:bg-white/5 transition-all">
                                        <i data-lucide="lock" class="w-5 h-5"></i>
                                        <span>Cryptography</span>
                                    </a>
                                </div>
                            </div>
            
                            <!-- AI -->
                            <div>
                                <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3 px-4">AI</h3>
                                <div class="space-y-1">
                                     <a href="/static/neural_center.html" class="nav-item  flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300 hover:text-white hover:bg-white/5 transition-all">
                                        <i data-lucide="brain" class="w-5 h-5"></i>
                                        <span>Neural Center</span>
                                    </a>
                                </div>
                            </div>
                        </nav>
            
                        <div class="mt-8 pt-6 border-t border-gray-700">
                            <a href="/static/settings.html" class="nav-item  flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-400 hover:text-white hover:bg-white/5 transition-all">
                                <i data-lucide="settings" class="w-5 h-5"></i>
                                <span>Settings</span>
                            </a>
                            <a href="/logout" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-red-400 hover:text-red-300 hover:bg-red-500/10 transition-all">
                                <i data-lucide="log-out" class="w-5 h-5"></i>
                                <span>Logout</span>
                            </a>
                            <div class="mt-4 px-4 text-xs text-center text-gray-500 font-mono">
                                <p>Wolf Prowler v0.1.0</p>
                                <p class="mt-1">Encrypted • Secure</p>
                            </div>
                        </div>
                        
                        <!-- Live System Metrics Widget -->
                        <div class="mt-6 p-4 bg-gray-900/50 rounded-lg border border-gray-800">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs text-gray-400 uppercase">System Load</span>
                                <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between text-xs text-gray-300"><span>CPU</span> <span data-wolf-metric="cpu_usage">--%</span></div>
                                <div class="flex justify-between text-xs text-gray-300"><span>MEM</span> <span data-wolf-metric="memory_usage">--%</span></div>
                            </div>
                        </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="ml-64 p-8">
        <header class="flex justify-between items-center mb-8">
            <div>
                <h2 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">Wolf Cluster Consensus</h2>
                <div class="flex items-center mt-2 space-x-2">
                    <span id="cluster-indicator" class="relative flex h-3 w-3">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                    </span>
                    <span id="cluster-status-text" class="text-sm text-green-400 font-mono uppercase">Cluster Synchronized</span>
                </div>
            </div>
            <div class="flex space-x-4">
                <button onclick="refreshConsensus()" class="glass-morphism px-4 py-2 rounded-lg hover:bg-white/10 flex items-center space-x-2 transition-all">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    <span>Sync Now</span>
                </button>
            </div>
        </header>

        <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="metric-card rounded-xl p-6">
                <p class="text-xs text-gray-400 uppercase font-semibold">Local Node ID</p>
                <h4 id="local-node-id" class="text-2xl font-bold mt-2 font-mono text-purple-400">--</h4>
                <p id="local-node-role" class="text-xs mt-2 text-gray-500">Initializing...</p>
            </div>
            <div class="metric-card rounded-xl p-6">
                <p class="text-xs text-gray-400 uppercase font-semibold">Cluster Leader</p>
                <h4 id="cluster-leader-id" class="text-2xl font-bold mt-2 font-mono text-amber-400">--</h4>
                <p class="text-xs mt-2 text-gray-500">Term: <span id="current-term" class="text-gray-300">--</span></p>
            </div>
            <div class="metric-card rounded-xl p-6">
                <p class="text-xs text-gray-400 uppercase font-semibold">Known Peers</p>
                <h4 id="peers-count" class="text-2xl font-bold mt-2 font-mono text-blue-400">--</h4>
                <p class="text-xs mt-2 text-gray-500">Quorum Requirement: <span id="quorum-req" class="text-gray-300">--</span></p>
            </div>
            <div class="metric-card rounded-xl p-6">
                <p class="text-xs text-gray-400 uppercase font-semibold">State Version</p>
                <h4 id="state-index" class="text-2xl font-bold mt-2 font-mono text-green-400">--</h4>
                <p class="text-xs mt-2 text-gray-500">Last Applied Index</p>
            </div>
        </div>

        <!-- Distributed Log and State -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left: Shared State Explorer -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Synchronized Threats -->
                <section class="metric-card rounded-2xl p-6 overflow-hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold flex items-center text-red-400">
                            <i data-lucide="flame" class="w-6 h-6 mr-2"></i> Synchronized Threats
                        </h3>
                        <span class="px-3 py-1 bg-red-500/10 text-red-500 text-xs rounded-full border border-red-500/20">Global Blocklist</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left font-mono text-sm">
                            <thead class="text-gray-500 border-b border-gray-800">
                                <tr>
                                    <th class="pb-3 px-4">ID</th>
                                    <th class="pb-3 px-4">IP Address</th>
                                    <th class="pb-3 px-4">Severity</th>
                                    <th class="pb-3 px-4">Detected By</th>
                                </tr>
                            </thead>
                            <tbody id="threats-table-body">
                                <tr><td colspan="4" class="py-12 text-center text-gray-600">No synchronized threats detected.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Synchronized Firewall Rules -->
                <section class="metric-card rounded-2xl p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold flex items-center text-blue-400">
                            <i data-lucide="shield" class="w-6 h-6 mr-2"></i> Cluster Firewall
                        </h3>
                        <span class="px-3 py-1 bg-blue-500/10 text-blue-500 text-xs rounded-full border border-blue-500/20 text-xs">Propagated Rules</span>
                    </div>
                    <div id="firewall-rules-list" class="space-y-3">
                        <div class="text-center py-8 text-gray-600 font-mono italic">Awaiting state synchronization...</div>
                    </div>
                </section>
            </div>

            <!-- Right: Cluster Control & Log -->
            <div class="space-y-8">
                <!-- Proposal Portal -->
                <section class="metric-card rounded-2xl p-6 border-t-4 border-purple-500">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i data-lucide="plus-circle" class="w-5 h-5 mr-2 text-purple-400"></i> Submit Proposal
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs text-gray-500 uppercase block mb-2">Proposal Type</label>
                            <select id="proposal-type" class="w-full bg-black/40 border border-gray-700 rounded-lg p-3 text-sm focus:border-purple-500 outline-none transition-all">
                                <option value="AddThreat">Global Threat Block</option>
                                <option value="AddFirewallRule">Cluster Firewall Rule</option>
                                <option value="UpdateTrust">Trust Score Adjustment</option>
                            </select>
                        </div>
                        <div id="proposal-inputs" class="space-y-4">
                            <!-- Dynamic inputs based on type -->
                            <input type="text" id="prop-ip" placeholder="Target IP Address" class="w-full bg-black/40 border border-gray-700 rounded-lg p-3 text-sm focus:border-purple-500 outline-none transition-all">
                            <textarea id="prop-reason" placeholder="Reason for proposal..." class="w-full bg-black/40 border border-gray-700 rounded-lg p-3 text-sm focus:border-purple-500 outline-none transition-all h-24"></textarea>
                        </div>
                        <button onclick="submitProposal()" id="submit-btn" class="w-full py-3 bg-purple-600 hover:bg-purple-500 rounded-lg font-bold transition-all shadow-lg shadow-purple-600/20 disabled:opacity-50 disabled:cursor-not-allowed">
                            Propose to Cluster
                        </button>
                    </div>
                </section>

                <!-- Cluster Topology -->
                <section class="metric-card rounded-2xl p-6">
                    <h3 class="text-lg font-bold mb-4">Cluster Topology</h3>
                    <div id="nodes-list" class="space-y-4">
                        <!-- Node elements injected here -->
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        let localNodeId = 0;
        let isLeader = false;

        // Helper for API calls since we removed api.js
        async function getJson(url) { const r = await fetch(url); return r.json(); }
        async function postJson(url, data) { const r = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) }); return r.json(); }

        async function refreshConsensus() {
            try {
                const status = await getJson('/api/v1/consensus/status');
                const sharedState = await getJson('/api/v1/consensus/state');

                updateStats(status, sharedState);
                updateThreats(sharedState.threats);
                updateFirewall(sharedState.firewall_rules);
                updateTopology(status);

                localNodeId = status.node_id;
                isLeader = status.state === 'Leader';
                
                document.getElementById('submit-btn').disabled = !isLeader;
                if(!isLeader) {
                     document.getElementById('local-node-role').innerHTML = `<span class="text-gray-400">Follower</span>`;
                } else {
                     document.getElementById('local-node-role').innerHTML = `<span class="text-amber-400 font-bold">Leader</span>`;
                }

            } catch (e) {
                console.error("Consensus sync failed", e);
                // window.wolf.showToast("Synchronization failed", "error"); // Optional: don't spam on connection loss
            }
        }

        function updateStats(status, state) {
            document.getElementById('local-node-id').textContent = 'OWL-' + status.node_id;
            document.getElementById('cluster-leader-id').textContent = status.leader_id ? 'OWL-' + status.leader_id : 'ELECTION...';
            document.getElementById('current-term').textContent = status.term;
            document.getElementById('peers-count').textContent = status.peers.length;
            document.getElementById('quorum-req').textContent = Math.floor(status.peers.length / 2) + 1;
            document.getElementById('state-index').textContent = state.last_applied;

            const indicator = document.getElementById('cluster-indicator').querySelector('span:last-child');
            if (status.leader_id) {
                indicator.className = 'relative inline-flex rounded-full h-3 w-3 bg-green-500';
                document.getElementById('cluster-status-text').textContent = 'Cluster Synchronized';
                document.getElementById('cluster-status-text').className = 'text-sm text-green-400 font-mono uppercase';
            } else {
                indicator.className = 'relative inline-flex rounded-full h-3 w-3 bg-amber-500';
                document.getElementById('cluster-status-text').textContent = 'Election in Progress';
                document.getElementById('cluster-status-text').className = 'text-sm text-amber-400 font-mono uppercase';
            }
        }

        function updateThreats(threats) {
            const body = document.getElementById('threats-table-body');
            const threatList = Object.values(threats);
            if (threatList.length === 0) {
                body.innerHTML = '<tr><td colspan="4" class="py-12 text-center text-gray-600">No synchronized threats detected.</td></tr>';
                return;
            }

            body.innerHTML = threatList.map(t => `
                <tr class="border-b border-gray-800/50 hover:bg-white/5 transition-all">
                    <td class="py-4 px-4 text-gray-400">${t.id.substring(0, 8)}...</td>
                    <td class="py-4 px-4 text-white">${t.ip}</td>
                    <td class="py-4 px-4 text-red-500 uppercase font-bold text-xs">${t.severity}</td>
                    <td class="py-4 px-4 text-gray-500">Nodes: ${t.detected_by.join(', ')}</td>
                </tr>
            `).join('');
        }

        function updateFirewall(rules) {
            const list = document.getElementById('firewall-rules-list');
            if (rules.length === 0) {
                list.innerHTML = '<div class="text-center py-8 text-gray-600 font-mono italic">No active cluster-wide rules.</div>';
                return;
            }

            list.innerHTML = rules.map(r => `
                <div class="flex items-center justify-between p-4 bg-black/40 rounded-xl border border-gray-800 hover:border-blue-500/30 transition-all">
                    <div class="flex items-center space-x-4">
                        <div class="p-2 ${r.action === 'Allow' ? 'bg-green-500/10 text-green-500' : 'bg-red-500/10 text-red-500'} rounded-lg">
                            <i data-lucide="${r.action === 'Allow' ? 'check-circle' : 'slash'}" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <p class="text-sm font-bold">${r.action} incoming from ${r.source_ip || 'ANY'}</p>
                            <p class="text-xs text-gray-500">Target: ${r.target_port || 'ALL'} • Priority: ${r.priority}</p>
                        </div>
                    </div>
                    <span class="text-[10px] text-gray-600 font-mono uppercase tracking-tighter">Sync Global</span>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function updateTopology(status) {
            const list = document.getElementById('nodes-list');
            const nodes = [status.node_id, ...status.peers];
            
            list.innerHTML = nodes.map(id => {
                const isLocal = id === status.node_id;
                const isLeader = id === status.leader_id;
                
                return `
                    <div class="flex items-center justify-between p-4 glass-morphism rounded-xl ${isLeader ? 'border-amber-500/50' : ''} ${isLocal ? 'bg-purple-500/5' : ''}">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center ${isLeader ? 'bg-amber-500/20 text-amber-500' : 'bg-gray-800 text-gray-400'}">
                                <i data-lucide="${isLeader ? 'crown' : 'server'}" class="w-4 h-4"></i>
                            </div>
                            <div>
                                <p class="text-sm font-bold font-mono text-gray-200">OWL-${id} ${isLocal ? '<span class="text-xs text-purple-500 ml-1">(YOU)</span>' : ''}</p>
                                <p class="text-[10px] text-gray-500 uppercase">${isLeader ? 'Cluster Leader' : 'Follower Node'}</p>
                            </div>
                        </div>
                        <div class="h-2 w-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]"></div>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        async function submitProposal() {
            if (!isLeader) {
                window.wolf.showToast("Only the Leader can submit proposals", "error");
                return;
            }

            const type = document.getElementById('proposal-type').value;
            const ip = document.getElementById('prop-ip').value;
            const reason = document.getElementById('prop-reason').value;

            if (!ip) {
                window.wolf.showToast("IP address is required", "warning");
                return;
            }

            let proposal = {};
            if (type === 'AddThreat') {
                proposal = {
                    AddThreat: {
                        threat: {
                            id: "manual-" + Date.now(),
                            ip: ip,
                            severity: "High",
                            detected_by: [localNodeId],
                            first_seen: new Date().toISOString(),
                            last_seen: new Date().toISOString(),
                            blocked: true
                        },
                        proposer: localNodeId
                    }
                };
            } else if (type === 'AddFirewallRule') {
                 proposal = {
                    AddFirewallRule: {
                        rule: {
                            id: "global-" + Date.now(),
                            source_ip: ip,
                            target_port: null,
                            protocol: "Any",
                            action: "Block",
                            priority: 100,
                            description: reason || "Manual Cluster Block"
                        },
                        proposer: localNodeId
                    }
                };
            }

            try {
                const response = await postJson('/api/v1/consensus/propose', proposal);
                if (response.success) {
                    window.wolf.showToast("Proposal submitted to log", "success");
                    document.getElementById('prop-ip').value = '';
                    document.getElementById('prop-reason').value = '';
                    // No need to timeout refresh, WS will push update
                }
            } catch (e) {
                window.wolf.showToast("Proposal rejected: " + e.message, "error");
            }
        }

        // Initial Load
        refreshConsensus();

        // Real-time Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Listen for consensus updates pushed from backend
            window.wolf.on('consensus_update', (data) => {
                // We can use the data directly or trigger a full refresh to get complex state like threats/firewall
                // For now, let's trigger refresh to ensure full state consistency
                refreshConsensus();
            });
        });

    </script>
</body>

</html>
