<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Threat Detection - Wolf Prowler</title>

    <!-- External Resources -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/threats.css">
    <script src="/static/js/wolf_live.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --accent-red: #ff4d4d;
        }
        body { background-color: var(--bg-primary); }
        .wolf-bg {
            background: linear-gradient(135deg, rgba(255, 77, 77, 0.1) 0%, rgba(200, 0, 0, 0.1) 100%);
        }
    </style>
</head>

<body class="text-gray-200">

    <!-- Sidebar -->
    <div id="sidebar" class="glass-morphism">
        <div class="sidebar-header wolf-bg">
            <div class="flex items-center space-x-3">
                <div
                    class="w-10 h-10 bg-gradient-to-br from-purple-500 to-blue-500 rounded-lg flex items-center justify-center">
                    <i data-lucide="shield" class="w-6 h-6 text-white"></i>
                </div>
                <div class="sidebar-header-text">
                    <h1 class="text-lg font-bold glow-text text-white">Wolf Prowler</h1>
                    <p class="text-xs text-gray-400 mono-font">v2.5.0</p>
                </div>
            </div>
        </div>

        <nav class="px-4 pb-6 overflow-y-auto" style="height: calc(100% - 80px);">
            <div class="space-y-1">
                <p class="text-xs text-gray-500 font-semibold px-4 py-2 uppercase tracking-wider sidebar-header-text">
                    Main</p>
                <a href="/index.html" class="nav-item">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    <span class="nav-text">Dashboard</span>
                </a>
                <a href="/neural_center.html" class="nav-item">
                    <i data-lucide="brain" class="w-5 h-5"></i>
                    <span class="nav-text">Neural Center</span>
                </a>

                <p
                    class="text-xs text-gray-500 font-semibold px-4 py-2 mt-4 uppercase tracking-wider sidebar-header-text">
                    Security</p>
                <a href="/threat_detection.html" class="nav-item active">
                    <i data-lucide="radiation" class="w-5 h-5"></i>
                    <span class="nav-text">Threat Detection</span>
                </a>
                <a href="/compliance.html" class="nav-item">
                    <i data-lucide="clipboard-check" class="w-5 h-5"></i>
                    <span class="nav-text">Compliance</span>
                </a>
                <a href="/crypto_advanced_v2.html" class="nav-item">
                    <i data-lucide="key" class="w-5 h-5"></i>
                    <span class="nav-text">Crypto Tools</span>
                </a>

                <p
                    class="text-xs text-gray-500 font-semibold px-4 py-2 mt-4 uppercase tracking-wider sidebar-header-text">
                    Network</p>
                <a href="/static/network_map.html" class="nav-item">
                    <i data-lucide="network" class="w-5 h-5"></i>
                    <span class="nav-text">Network Map</span>
                </a>
                <a href="/wolf_howl.html" class="nav-item">
                    <i data-lucide="users" class="w-5 h-5"></i>
                    <span class="nav-text">P2P Network</span>
                </a>
                <a href="/wolf_howl.html" class="nav-item">
                    <i data-lucide="radio" class="w-5 h-5"></i>
                    <span class="nav-text">Howl Discovery</span>
                </a>

                <p
                    class="text-xs text-gray-500 font-semibold px-4 py-2 mt-4 uppercase tracking-wider sidebar-header-text">
                    System</p>
                <a href="/monitoring.html" class="nav-item">
                    <i data-lucide="activity" class="w-5 h-5"></i>
                    <span class="nav-text">Monitoring</span>
                </a>
                <a href="/logs.html" class="nav-item">
                    <i data-lucide="file-text" class="w-5 h-5"></i>
                    <span class="nav-text">Logs</span>
                </a>
                <a href="/settings.html" class="nav-item">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    <span class="nav-text">Settings</span>
                </a>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div id="main-content">
        <!-- Top Header -->
        <header class="glass-morphism h-16 px-8 flex items-center justify-between sticky top-0 z-40 bg-gray-900/80">
            <div class="flex items-center">
                <button id="sidebar-toggle" class="text-gray-400 hover:text-white focus:outline-none mr-4"
                    aria-label="Toggle Sidebar">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
                <h2 class="text-xl font-semibold text-white">Active Threat Landscape</h2>
            </div>
            <div class="flex items-center space-x-4">
                <button onclick="refreshData()" class="text-gray-400 hover:text-white transition-colors p-2"
                    aria-label="Refresh Data" title="Refresh Data">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                </button>
                <div class="flex items-center px-3 py-1 bg-red-500/10 rounded-full border border-red-500/20">
                    <i data-lucide="siren" class="w-3 h-3 text-red-400 mr-2"></i>
                    <span class="text-xs font-medium text-red-400">Live Monitoring</span>
                </div>
            </div>
        </header>

        <!-- Content Area -->
        <main class="p-8">
            <!-- Threat Intelligence Card -->
            <div class="threat-card mb-8 border-l-4 border-blue-500">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-white m-0">Threat Intelligence</h3>
                    <span class="text-sm text-gray-400" id="last-updated">Updating...</span>
                </div>
                <div id="intel-stats" class="mt-4 flex gap-6">
                    <!-- Stats will be injected here -->
                    <div class="text-gray-400">Loading intel...</div>
                </div>
            </div>

            <!-- Threat List -->
            <div id="threat-list" class="space-y-4">
                <div class="text-center py-10 text-gray-500">
                    <i class="fas fa-circle-notch fa-spin mr-2"></i> Loading active threats...
                </div>
            </div>
        </main>
    </div>

    <script>
        // Threat Logic
        async function refreshData() {
            showToast('Refreshing threat feeds...', 'info');
            await Promise.all([loadIntelligence(), loadThreats()]);
            showToast('Threat feeds updated', 'success');
        }

        function showToast(msg, type) { if(window.wolf) window.wolf.showToast(msg, type); }

        async function loadIntelligence() {
            try {
                const resp = await fetch('/api/v1/threat/intelligence');
                const data = await resp.json();

                if (data.timestamp) {
                    const date = new Date(data.timestamp);
                    document.getElementById('last-updated').textContent = 'Last Updated: ' + date.toLocaleString();
                }

                if (data.intelligence) {
                    const i = data.intelligence;
                    document.getElementById('intel-stats').innerHTML = `
                        <div class="flex items-center gap-2">
                            <i data-lucide="database" class="w-4 h-4 text-blue-400"></i>
                            <span class="text-gray-300">Total Threats: <strong class="text-white">${i.total_threats}</strong></span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i data-lucide="layers" class="w-4 h-4 text-purple-400"></i>
                            <span class="text-gray-300">Unique Types: <strong class="text-white">${Object.keys(i.type_distribution || {}).length}</strong></span>
                        </div>
                    `;
                    lucide.createIcons(); // Re-init icons for injected content
                }
            } catch (error) {
                console.error('Error loading intelligence:', error);
            }
        }

        async function loadThreats() {
            try {
                const resp = await fetch('/api/v1/active/threats');
                const data = await resp.json();
                const container = document.getElementById('threat-list');

                if (data.active_threats.length === 0) {
                    if(container.innerHTML.includes('Loading')) container.innerHTML = `
                        <div class="glass-morphism p-8 rounded-xl text-center">
                            <i data-lucide="shield-check" class="w-12 h-12 text-green-500 mx-auto mb-4"></i>
                            <h3 class="text-xl font-bold text-white mb-2">System Secure</h3>
                            <p class="text-gray-400">No active threats detected. Pack is safe.</p>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                container.innerHTML = data.active_threats.map(t => createThreatCard(t)).join('');
                lucide.createIcons();
            } catch (e) {
                console.error("Failed to load threats", e);
            }
        }

        function getSeverityColor(severity) {
            const s = severity.toLowerCase();
            if (s === 'critical' || s === 'high') return 'red-500';
            if (s === 'medium') return 'orange-500';
            return 'blue-500';
        }

        function createThreatCard(t) {
            return `
                <div class="threat-card severity-${t.severity.toLowerCase()} glass-morphism p-6 rounded-lg border-l-4 mb-4 animate-fade-in">
                    <div class="flex justify-between items-start mb-2">
                        <strong class="text-lg text-white font-mono">${t.threat_type}</strong>
                        <span class="text-xs text-gray-400 font-mono">${new Date(t.detected_at || Date.now()).toLocaleString()}</span>
                    </div>
                    <p class="text-gray-300 mb-4">${t.description || 'No description provided.'}</p>
                    <div class="flex justify-between items-center text-xs text-gray-500 mt-2 pt-2 border-t border-gray-700">
                            <span>Source: <span class="text-gray-300">${t.source_peer || 'Internal'}</span></span>
                            <span class="px-2 py-1 rounded bg-gray-800 text-gray-300 uppercase tracking-widest text-[10px]">${t.status || 'Active'}</span>
                    </div>
                </div>
            `;
        }

        loadThreats();
        loadIntelligence();

        // Real-time updates via Wolf Live
        document.addEventListener('DOMContentLoaded', () => {
            window.wolf.on('security_event', (event) => {
                // Prepend new threat to list
                const container = document.getElementById('threat-list');
                
                // Remove "System Secure" placeholder if it exists
                if (container.innerHTML.includes('System Secure')) container.innerHTML = '';

                const threatData = {
                    threat_type: event.event_type,
                    severity: event.severity,
                    description: event.message,
                    detected_at: event.timestamp,
                    source_peer: event.peer_id,
                    status: 'New'
                };
                container.insertAdjacentHTML('afterbegin', createThreatCard(threatData));
                lucide.createIcons();
            });
        });
    </script>
</body>

</html>